<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sylvia Insurance ‚Äî Prior Authorization Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Nunito+Sans:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --green:    #78BE20;
      --green-dk: #5a9118;
      --green-lt: #e8f5d0;
      --navy:     #003057;
      --navy-lt:  #004480;
      --magenta:  #AF0061;
      --gray-dk:  #3A3B3D;
      --gray-md:  #6b6c6e;
      --gray-lt:  #f4f6f8;
      --white:    #ffffff;
      --border:   #dde3e8;
      --shadow:   0 2px 12px rgba(0,48,87,0.10);
      --shadow-lg:0 8px 32px rgba(0,48,87,0.14);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Nunito Sans', sans-serif;
      background: var(--gray-lt);
      color: var(--gray-dk);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
    nav {
      background: var(--white);
      border-bottom: 3px solid var(--green);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 40px;
      height: 64px;
      box-shadow: 0 2px 8px rgba(0,48,87,0.08);
    }
    .logo {
      font-family: 'Nunito', sans-serif;
      font-weight: 900;
      font-size: 1.6rem;
      color: var(--navy);
      letter-spacing: -0.5px;
    }
    .logo span { color: var(--green); }
    .nav-badge {
      background: var(--green-lt);
      color: var(--green-dk);
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid var(--green);
    }

    /* ‚îÄ‚îÄ HERO STRIP ‚îÄ‚îÄ */
    .hero {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-lt) 100%);
      color: white;
      padding: 36px 40px 32px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .hero-icon {
      width: 56px; height: 56px;
      background: var(--green);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6rem;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(120,190,32,0.4);
    }
    .hero h1 {
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1.5rem;
      margin-bottom: 4px;
    }
    .hero p {
      font-size: 0.9rem;
      opacity: 0.82;
      font-weight: 400;
      max-width: 560px;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      padding: 28px 40px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-header h2 {
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1rem;
      color: var(--navy);
    }
    .card-header .icon {
      width: 32px; height: 32px;
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
    }
    .icon-green { background: var(--green-lt); }
    .icon-navy  { background: #e0e9f5; }

    .card-body { padding: 24px; }

    /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
    .field { margin-bottom: 18px; }
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--navy);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.92rem;
      color: var(--gray-dk);
      background: var(--white);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(120,190,32,0.15);
    }
    textarea { resize: vertical; min-height: 90px; }
    select { cursor: pointer; }

    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

    .quick-fill {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }
    .quick-fill-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--gray-md);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
      margin-bottom: 2px;
    }
    .qbtn {
      background: var(--gray-lt);
      border: 1.5px solid var(--border);
      color: var(--navy);
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      font-size: 0.75rem;
      padding: 5px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .qbtn:hover {
      background: var(--navy);
      color: white;
      border-color: var(--navy);
    }

    .submit-btn {
      width: 100%;
      padding: 13px;
      background: var(--green);
      color: white;
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-btn:hover { background: var(--green-dk); }
    .submit-btn:active { transform: scale(0.99); }
    .submit-btn:disabled {
      background: #b0c890;
      cursor: not-allowed;
    }

    /* ‚îÄ‚îÄ RESPONSE PANEL ‚îÄ‚îÄ */
    .response-idle {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 48px 24px;
      color: var(--gray-md);
      gap: 12px;
      min-height: 300px;
    }
    .response-idle .big-icon { font-size: 2.8rem; opacity: 0.35; }
    .response-idle p { font-size: 0.9rem; line-height: 1.5; max-width: 260px; }

    /* ‚îÄ‚îÄ DECISION BADGE ‚îÄ‚îÄ */
    .decision-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      border-radius: 30px;
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1rem;
      letter-spacing: 0.02em;
      margin-bottom: 20px;
    }
    .badge-approved   { background: #e8f5d0; color: #3d7010; border: 2px solid var(--green); }
    .badge-denied     { background: #fde8f0; color: #7a0040; border: 2px solid var(--magenta); }
    .badge-pending    { background: #fff3cd; color: #7a5c00; border: 2px solid #f0c040; }

    .response-content { padding: 24px; }

    .section-label {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--gray-md);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 8px;
      margin-top: 20px;
    }
    .section-label:first-of-type { margin-top: 0; }

    .reasoning-box {
      background: var(--gray-lt);
      border-left: 3px solid var(--navy);
      border-radius: 0 8px 8px 0;
      padding: 14px 16px;
      font-size: 0.9rem;
      line-height: 1.65;
      color: var(--gray-dk);
    }

    .next-steps-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .next-steps-list li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 0.88rem;
      line-height: 1.5;
    }
    .step-dot {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--navy);
      color: white;
      font-size: 0.65rem;
      font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .criteria-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.83rem;
      padding: 8px 12px;
      background: var(--gray-lt);
      border-radius: 8px;
    }
    .criteria-item.met   { color: #3d7010; }
    .criteria-item.unmet { color: #7a0040; }
    .criteria-item.info  { color: #555; }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 64px 24px;
    }
    .spinner {
      width: 44px; height: 44px;
      border: 4px solid var(--green-lt);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-state p {
      color: var(--gray-md);
      font-size: 0.88rem;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.75rem;
      color: var(--gray-md);
    }

    @media (max-width: 860px) {
      .main { grid-template-columns: 1fr; padding: 20px; }
      .hero { padding: 24px 20px; }
      nav { padding: 0 20px; }
    }

    /* ‚îÄ‚îÄ API KEY MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 48, 87, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }
    .modal-overlay.hidden { display: none; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 36px;
      max-width: 440px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,48,87,0.25);
      animation: slideUp 0.25s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .modal-logo {
      font-family: 'Nunito', sans-serif;
      font-weight: 900;
      font-size: 1.8rem;
      color: var(--navy);
      margin-bottom: 4px;
    }
    .modal-logo span { color: var(--green); }
    .modal h3 {
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1.1rem;
      color: var(--navy);
      margin-bottom: 8px;
    }
    .modal p {
      font-size: 0.85rem;
      color: var(--gray-md);
      line-height: 1.55;
      margin-bottom: 20px;
    }
    .modal p a {
      color: var(--green-dk);
      font-weight: 700;
      text-decoration: none;
    }
    .modal p a:hover { text-decoration: underline; }
    .modal input[type="password"],
    .modal input[type="text"] {
      width: 100%;
      padding: 11px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-family: 'Nunito Sans', sans-serif;
      font-size: 0.92rem;
      margin-bottom: 12px;
      letter-spacing: 0.05em;
    }
    .modal input:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 3px rgba(120,190,32,0.15);
      outline: none;
    }
    .modal-actions { display: flex; gap: 10px; }
    .modal-submit {
      flex: 1;
      padding: 11px;
      background: var(--green);
      color: white;
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 0.95rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-submit:hover { background: var(--green-dk); }
    .modal-note {
      margin-top: 14px;
      font-size: 0.75rem;
      color: var(--gray-md);
      display: flex;
      align-items: flex-start;
      gap: 6px;
      line-height: 1.4;
    }
    .key-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      background: white;
      color: var(--gray-md);
      transition: all 0.15s;
    }
    .key-status:hover { border-color: var(--navy); color: var(--navy); }
    .key-status.active { border-color: var(--green); color: var(--green-dk); background: var(--green-lt); }
    .key-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
    }
    .key-dot.active { background: var(--green); }

    /* entrance animation */
    .card { animation: fadeUp 0.35s ease both; }
    .card:nth-child(2) { animation-delay: 0.1s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<nav>
  <div class="logo">Sylvia<span>.</span></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="key-status" id="keyStatus" onclick="showKeyModal()">
      <div class="key-dot" id="keyDot"></div>
      <span id="keyStatusText">Enter API Key</span>
    </button>
    <div class="nav-badge">‚ú¶ AI-Powered Demo</div>
  </div>
</nav>

<!-- API KEY MODAL -->
<div class="modal-overlay" id="keyModal">
  <div class="modal">
    <div class="modal-logo">Sylvia<span>.</span></div>
    <h3>Enter your Anthropic API Key</h3>
    <p>Your key is stored in memory only ‚Äî never saved, never sent anywhere except directly to Anthropic's API, and disappears when you close the tab. Get a key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>.</p>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-..." />
    <div class="modal-actions">
      <button class="modal-submit" onclick="saveApiKey()">Start Demo ‚Üí</button>
    </div>
    <div class="modal-note">üîí Key lives in memory only ¬∑ Never committed to code ¬∑ Clears on tab close</div>
  </div>
</div>

<div class="hero">
  <div class="hero-icon">üè•</div>
  <div>
    <h1>Prior Authorization Assistant</h1>
    <p>Submit a clinical request and receive an AI-powered coverage decision in seconds ‚Äî with transparent reasoning and clear next steps.</p>
  </div>
</div>

<div class="main">

  <!-- LEFT: FORM -->
  <div class="card">
    <div class="card-header">
      <div class="icon icon-green">üìã</div>
      <h2>Authorization Request</h2>
    </div>
    <div class="card-body">

      <div class="quick-fill">
        <div class="quick-fill-label">‚ö° Load example case</div>
        <button class="qbtn" onclick="loadCase('mri')">MRI ‚Äî Back Pain</button>
        <button class="qbtn" onclick="loadCase('humira')">Humira ‚Äî RA</button>
        <button class="qbtn" onclick="loadCase('sleep')">Sleep Study</button>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Patient Name</label>
          <input type="text" id="patientName" placeholder="Jane Doe" />
        </div>
        <div class="field">
          <label>Member ID</label>
          <input type="text" id="memberId" placeholder="HUM-0000000" />
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Date of Birth</label>
          <input type="text" id="dob" placeholder="MM/DD/YYYY" />
        </div>
        <div class="field">
          <label>Plan Type</label>
          <select id="planType">
            <option value="">Select plan</option>
            <option>Medicare Advantage ‚Äî HMO</option>
            <option>Medicare Advantage ‚Äî PPO</option>
            <option>Individual &amp; Family ‚Äî Bronze</option>
            <option>Individual &amp; Family ‚Äî Gold</option>
            <option>Medicaid Managed Care</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Requesting Provider / NPI</label>
        <input type="text" id="provider" placeholder="Dr. Maria Santos / NPI 1234567890" />
      </div>

      <div class="field-row">
        <div class="field">
          <label>Procedure / Treatment</label>
          <input type="text" id="procedure" placeholder="MRI Lumbar Spine" />
        </div>
        <div class="field">
          <label>CPT / HCPCS Code</label>
          <input type="text" id="cptCode" placeholder="72148" />
        </div>
      </div>

      <div class="field">
        <label>Primary Diagnosis (ICD-10)</label>
        <input type="text" id="diagnosis" placeholder="M54.5 ‚Äî Low back pain" />
      </div>

      <div class="field">
        <label>Clinical Notes &amp; Justification</label>
        <textarea id="clinicalNotes" placeholder="Describe the clinical indication, prior treatments tried, and medical necessity..."></textarea>
      </div>

      <button class="submit-btn" id="submitBtn" onclick="submitRequest()">
        <span>Submit for AI Review</span>
        <span>‚Üí</span>
      </button>
    </div>
  </div>

  <!-- RIGHT: RESPONSE -->
  <div class="card" id="responseCard">
    <div class="card-header">
      <div class="icon icon-navy">ü§ñ</div>
      <h2>AI Coverage Decision</h2>
    </div>

    <div id="responsePanel">
      <div class="response-idle">
        <div class="big-icon">üîç</div>
        <p>Complete the request form and submit for an instant AI-powered prior authorization decision.</p>
      </div>
    </div>
  </div>

</div>

<div class="footer">Sylvia Insurance ¬∑ AI Demo Environment ¬∑ Not for clinical use ¬∑ Powered by Claude</div>

<script>
// ‚îÄ‚îÄ API KEY MANAGEMENT ‚îÄ‚îÄ
let _apiKey = null;

function showKeyModal() {
  document.getElementById('keyModal').classList.remove('hidden');
  document.getElementById('apiKeyInput').focus();
}

function saveApiKey() {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val.startsWith('sk-ant-')) {
    document.getElementById('apiKeyInput').style.borderColor = 'var(--magenta)';
    document.getElementById('apiKeyInput').placeholder = 'Key should start with sk-ant-...';
    return;
  }
  _apiKey = val;
  document.getElementById('keyModal').classList.add('hidden');
  document.getElementById('keyDot').classList.add('active');
  document.getElementById('keyStatus').classList.add('active');
  document.getElementById('keyStatusText').textContent = 'Key Active';
}

// Allow Enter key in modal
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('apiKeyInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') saveApiKey();
  });
});

const CASES = {
  mri: {
    patientName: 'Robert Chen',
    memberId: 'HUM-4821039',
    dob: '08/14/1958',
    planType: 'Medicare Advantage ‚Äî HMO',
    provider: 'Dr. Maria Santos / NPI 1239874560',
    procedure: 'MRI Lumbar Spine without contrast',
    cptCode: '72148',
    diagnosis: 'M54.5 ‚Äî Low back pain',
    clinicalNotes: 'Patient is a 65-year-old male presenting with 6 weeks of progressive lower back pain radiating to the left leg. Pain severity 7/10. Conservative treatment has been attempted including 4 weeks of physical therapy and NSAIDs with inadequate relief. Neurological symptoms include left L4-L5 dermatomal numbness. Requesting MRI to evaluate for disc herniation or spinal stenosis prior to consideration of interventional management.'
  },
  humira: {
    patientName: 'Sarah Mitchell',
    memberId: 'HUM-7743201',
    dob: '03/22/1972',
    planType: 'Individual & Family ‚Äî Gold',
    provider: 'Dr. James Park, Rheumatology / NPI 9871234560',
    procedure: 'Humira (adalimumab) 40mg biweekly injection',
    cptCode: 'J0135',
    diagnosis: 'M05.79 ‚Äî Rheumatoid Arthritis with rheumatoid factor',
    clinicalNotes: 'Patient has confirmed seropositive rheumatoid arthritis diagnosed 18 months ago. Has failed adequate trials of methotrexate (6 months at therapeutic dose) and hydroxychloroquine (4 months). Current DAS28 score is 5.2, indicating high disease activity. Labs confirm elevated CRP and ESR. Patient is not pregnant. Requesting step-up to biologic therapy with adalimumab per ACR guidelines for moderate-to-severe RA refractory to conventional DMARDs.'
  },
  sleep: {
    patientName: 'Patricia Williams',
    memberId: 'HUM-9934512',
    dob: '11/05/1965',
    planType: 'Medicare Advantage ‚Äî PPO',
    provider: 'Dr. Alan Torres, Sleep Medicine / NPI 4561237890',
    procedure: 'Attended polysomnography (overnight sleep study)',
    cptCode: '95810',
    diagnosis: 'G47.33 ‚Äî Obstructive sleep apnea',
    clinicalNotes: 'Patient reports 2 years of excessive daytime sleepiness, loud snoring, and witnessed apnea events per bed partner. Epworth Sleepiness Scale score 16/24. BMI 33.4. Neck circumference 41cm. No prior sleep study on file. Home sleep apnea test (HSAT) not appropriate due to suspicion of comorbid periodic limb movement disorder and patient has severe COPD making home testing unreliable. Requesting in-lab polysomnography for definitive diagnosis and titration.'
  }
};

function loadCase(key) {
  const c = CASES[key];
  document.getElementById('patientName').value = c.patientName;
  document.getElementById('memberId').value = c.memberId;
  document.getElementById('dob').value = c.dob;
  document.getElementById('planType').value = c.planType;
  document.getElementById('provider').value = c.provider;
  document.getElementById('procedure').value = c.procedure;
  document.getElementById('cptCode').value = c.cptCode;
  document.getElementById('diagnosis').value = c.diagnosis;
  document.getElementById('clinicalNotes').value = c.clinicalNotes;
}

function getVal(id) { return document.getElementById(id).value.trim(); }

async function submitRequest() {
  const fields = {
    patientName: getVal('patientName'),
    memberId: getVal('memberId'),
    dob: getVal('dob'),
    planType: getVal('planType'),
    provider: getVal('provider'),
    procedure: getVal('procedure'),
    cptCode: getVal('cptCode'),
    diagnosis: getVal('diagnosis'),
    clinicalNotes: getVal('clinicalNotes')
  };

  if (!fields.procedure || !fields.clinicalNotes) {
    alert('Please fill in at minimum the Procedure and Clinical Notes fields.');
    return;
  }

  if (!_apiKey) {
    showKeyModal();
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerHTML = '<span>Analyzing request...</span>';

  document.getElementById('responsePanel').innerHTML = `
    <div class="loading-state">
      <div class="spinner"></div>
      <p>AI reviewing clinical criteria...</p>
    </div>`;

  try {
    const systemPrompt = `You are Sylvia, an AI prior authorization specialist for a health insurance company. You evaluate prior authorization requests from healthcare providers against standard clinical coverage criteria.

Analyze the submitted request and return a JSON response with EXACTLY this structure:
{
  "decision": "APPROVED" | "DENIED" | "PENDING - MORE INFO NEEDED",
  "confidence": "High" | "Moderate" | "Low",
  "summary": "1-2 sentence plain English summary of the decision",
  "reasoning": "3-5 sentences explaining the clinical rationale, citing specific criteria met or not met",
  "criteria": [
    { "label": "Short criterion name", "status": "met" | "unmet" | "info", "note": "brief note" }
  ],
  "nextSteps": ["Step 1", "Step 2", "Step 3"]
}

Coverage guidelines to apply:
- For imaging (MRI, CT): Require documentation of failed conservative treatment (typically 4-6 weeks), clinical indication, and absence of red flag conditions that would require emergent imaging.
- For biologics: Require documented failure of at least 2 conventional therapies at therapeutic doses, confirmed diagnosis, and no contraindications.
- For sleep studies: In-lab polysomnography is appropriate when home sleep apnea testing is contraindicated (severe cardiopulmonary disease, suspected non-OSA sleep disorders) or patient anatomy/comorbidities make home testing unreliable.
- Always evaluate medical necessity, appropriate diagnosis coding, and whether clinical notes support the requested intervention.

Return ONLY valid JSON, no markdown, no preamble.`;

    const userMsg = `Prior Authorization Request:
Patient: ${fields.patientName} | DOB: ${fields.dob} | Member ID: ${fields.memberId}
Plan: ${fields.planType}
Provider: ${fields.provider}
Procedure: ${fields.procedure} (${fields.cptCode})
Diagnosis: ${fields.diagnosis}

Clinical Notes:
${fields.clinicalNotes}`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': _apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userMsg }]
      })
    });

    const data = await response.json();
    const text = data.content[0].text;
    let result;
    try {
      result = JSON.parse(text);
    } catch {
      result = JSON.parse(text.replace(/```json|```/g, '').trim());
    }

    renderDecision(result, fields.patientName);
  } catch (err) {
    document.getElementById('responsePanel').innerHTML = `
      <div class="response-idle">
        <div class="big-icon">‚ö†Ô∏è</div>
        <p>Error contacting AI service. Please try again.<br/><small style="color:#999">${err.message}</small></p>
      </div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span>Submit for AI Review</span><span>‚Üí</span>';
  }
}

function renderDecision(r, patientName) {
  const badgeClass = r.decision.includes('APPROVED') ? 'badge-approved'
                   : r.decision.includes('DENIED')   ? 'badge-denied'
                   : 'badge-pending';
  const badgeIcon  = r.decision.includes('APPROVED') ? '‚úì'
                   : r.decision.includes('DENIED')   ? '‚úï'
                   : '‚è≥';

  const criteriaHTML = (r.criteria || []).map(c => {
    const icon = c.status === 'met' ? '‚úì' : c.status === 'unmet' ? '‚úï' : '‚Ñπ';
    return `<div class="criteria-item ${c.status}">
      <strong>${icon}</strong>
      <span><strong>${c.label}</strong>${c.note ? ' ‚Äî ' + c.note : ''}</span>
    </div>`;
  }).join('');

  const stepsHTML = (r.nextSteps || []).map((s, i) => `
    <li>
      <div class="step-dot">${i + 1}</div>
      <span>${s}</span>
    </li>`).join('');

  const confColor = r.confidence === 'High' ? '#3d7010' : r.confidence === 'Low' ? '#7a0040' : '#7a5c00';

  document.getElementById('responsePanel').innerHTML = `
    <div class="response-content">
      <div class="decision-badge ${badgeClass}">${badgeIcon} ${r.decision}</div>
      <div style="font-size:0.8rem;color:var(--gray-md);margin-bottom:16px;">
        Confidence: <strong style="color:${confColor}">${r.confidence}</strong> &nbsp;¬∑&nbsp; Patient: <strong>${patientName}</strong>
      </div>

      <div class="section-label">Summary</div>
      <p style="font-size:0.9rem;line-height:1.6;margin-bottom:4px;">${r.summary}</p>

      <div class="section-label">Clinical Reasoning</div>
      <div class="reasoning-box">${r.reasoning}</div>

      ${r.criteria && r.criteria.length ? `
      <div class="section-label">Coverage Criteria</div>
      <div class="criteria-grid">${criteriaHTML}</div>` : ''}

      ${r.nextSteps && r.nextSteps.length ? `
      <div class="section-label">Next Steps</div>
      <ul class="next-steps-list">${stepsHTML}</ul>` : ''}

      <div style="margin-top:20px;padding:10px 14px;background:#f0f4f8;border-radius:8px;font-size:0.75rem;color:var(--gray-md);line-height:1.5;">
        ‚ö†Ô∏è This AI decision is for demonstration purposes only and does not constitute an official coverage determination. All final decisions require human review.
      </div>
    </div>`;
}
</script>
</body>
</html>
